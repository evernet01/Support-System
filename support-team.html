<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EverNet - Support Team Portal</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Montserrat:wght@700;800;900&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --navy: #001f3f;
            --dark-navy: #00152c;
            --creator: #8B5CF6;
            --white: #ffffff;
            --light: #f8fafc;
            --bg-color: #f8fafc;
            --text-color: #001f3f;
            --card-bg: #ffffff;
            --border-color: #e2e8f0;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #17a2b8;
            --primary: #007bff;
        }

        [data-theme="dark"] {
            --bg-color: #0f172a;
            --text-color: #f1f5f9;
            --card-bg: #1e293b;
            --border-color: #334155;
            --navy: #f1f5f9;
            --light: #0f172a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Poppins", sans-serif;
        }

        body {
            background: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
        }

        /* ========== HEADER ========== */
        .support-header {
            background: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .support-brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .brand-logo {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--navy) 0%, var(--creator) 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
        }

        .brand-text {
            font-family: "Montserrat", sans-serif;
            font-weight: 800;
            font-size: 1.4em;
            background: linear-gradient(135deg, var(--navy) 0%, var(--creator) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .support-nav {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .agent-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 20px;
            background: rgba(40, 167, 69, 0.1);
            color: var(--success);
            font-weight: 500;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--creator) 0%, #7C3AED 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        /* ========== MAIN LAYOUT ========== */
        .support-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* ========== SIDEBAR ========== */
        .support-sidebar {
            width: 280px;
            background: var(--card-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .sidebar-section {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .section-title {
            font-size: 0.85em;
            text-transform: uppercase;
            color: #64748b;
            font-weight: 600;
            margin-bottom: 12px;
            letter-spacing: 0.5px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .stat-item {
            text-align: center;
            padding: 12px;
            background: var(--light);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .stat-value {
            font-size: 1.4em;
            font-weight: 700;
            color: var(--navy);
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 0.75em;
            color: #64748b;
        }

        .filters-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-btn {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px;
            background: var(--light);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-color);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }

        .filter-btn:hover {
            background: rgba(139, 92, 246, 0.1);
            border-color: var(--creator);
        }

        .filter-btn.active {
            background: rgba(139, 92, 246, 0.1);
            border-color: var(--creator);
            color: var(--creator);
            font-weight: 600;
        }

        .filter-count {
            background: var(--creator);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
        }

        .team-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .team-member {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-radius: 8px;
            background: var(--light);
            border: 1px solid var(--border-color);
        }

        .member-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--creator) 0%, #7C3AED 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.85em;
            font-weight: 600;
        }

        .member-info {
            flex: 1;
        }

        .member-name {
            font-weight: 500;
            font-size: 0.9em;
        }

        .member-role {
            font-size: 0.75em;
            color: #64748b;
        }

        .member-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-online {
            background: var(--success);
        }

        .status-offline {
            background: #64748b;
        }

        .status-busy {
            background: var(--warning);
        }

        /* ========== MAIN CONTENT ========== */
        .support-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Conversations List */
        .conversations-panel {
            width: 380px;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            background: var(--card-bg);
        }

        .panel-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .search-box {
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 10px 14px 10px 40px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--light);
            color: var(--text-color);
            font-size: 0.9em;
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #64748b;
        }

        .conversations-list {
            flex: 1;
            overflow-y: auto;
        }

        .conversation-item {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            gap: 12px;
        }

        .conversation-item:hover {
            background: rgba(139, 92, 246, 0.05);
        }

        .conversation-item.active {
            background: rgba(139, 92, 246, 0.1);
            border-left: 3px solid var(--creator);
        }

        .creator-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--creator) 0%, #7C3AED 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1.1em;
            flex-shrink: 0;
        }

        .conversation-info {
            flex: 1;
            min-width: 0;
        }

        .conversation-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 4px;
        }

        .creator-name {
            font-weight: 600;
            font-size: 0.95em;
            color: var(--text-color);
        }

        .conversation-time {
            font-size: 0.75em;
            color: #64748b;
        }

        .conversation-preview {
            font-size: 0.85em;
            color: #64748b;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 6px;
        }

        .conversation-meta {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .priority-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .priority-low {
            background: rgba(40, 167, 69, 0.1);
            color: var(--success);
        }

        .priority-medium {
            background: rgba(255, 193, 7, 0.1);
            color: var(--warning);
        }

        .priority-high {
            background: rgba(220, 53, 69, 0.1);
            color: var(--danger);
        }

        .priority-urgent {
            background: rgba(220, 53, 69, 0.2);
            color: var(--danger);
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .unread-count {
            background: var(--creator);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7em;
            font-weight: 600;
        }

        /* Chat Panel */
        .chat-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--card-bg);
        }

        .chat-header {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--card-bg);
        }

        .chat-creator-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .creator-details h3 {
            font-size: 1.1em;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 2px;
        }

        .creator-details p {
            font-size: 0.85em;
            color: #64748b;
        }

        .chat-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: var(--light);
            color: var(--text-color);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .action-btn:hover {
            background: rgba(139, 92, 246, 0.1);
            border-color: var(--creator);
            color: var(--creator);
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .message-date {
            text-align: center;
            margin: 20px 0;
            position: relative;
        }

        .date-label {
            background: var(--light);
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.85em;
            color: #64748b;
            display: inline-block;
            border: 1px solid var(--border-color);
        }

        .message {
            display: flex;
            gap: 10px;
            max-width: 75%;
        }

        .message.outgoing {
            margin-left: auto;
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--creator) 0%, #7C3AED 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8em;
            font-weight: 600;
            flex-shrink: 0;
        }

        .message-content {
            background: var(--light);
            padding: 12px 16px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            position: relative;
        }

        .message.outgoing .message-content {
            background: rgba(139, 92, 246, 0.1);
            border-color: rgba(139, 92, 246, 0.3);
        }

        .message-text {
            font-size: 0.95em;
            line-height: 1.5;
            color: var(--text-color);
        }

        .message-time {
            font-size: 0.75em;
            color: #64748b;
            margin-top: 4px;
            text-align: right;
        }

        .message-actions {
            position: absolute;
            right: 8px;
            top: 8px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .message:hover .message-actions {
            opacity: 1;
        }

        .chat-input-area {
            padding: 20px;
            border-top: 1px solid var(--border-color);
            background: var(--card-bg);
        }

        .chat-input-container {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            background: var(--light);
            color: var(--text-color);
            font-size: 0.95em;
            resize: none;
            min-height: 50px;
            max-height: 150px;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--creator);
        }

        .input-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .attachment-btn, .send-btn {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1em;
            transition: all 0.3s ease;
        }

        .attachment-btn {
            background: var(--light);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        .attachment-btn:hover {
            background: rgba(139, 92, 246, 0.1);
            border-color: var(--creator);
            color: var(--creator);
        }

        .send-btn {
            background: linear-gradient(135deg, var(--creator) 0%, #7C3AED 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
        }

        .send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
        }

        .send-btn:disabled {
            background: #64748b;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* ========== QUICK RESPONSES ========== */
        .quick-responses {
            margin-top: 12px;
        }

        .responses-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .responses-title {
            font-size: 0.85em;
            font-weight: 600;
            color: #64748b;
        }

        .responses-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .response-btn {
            padding: 6px 12px;
            background: var(--light);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-color);
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .response-btn:hover {
            background: rgba(139, 92, 246, 0.1);
            border-color: var(--creator);
            color: var(--creator);
        }

        /* ========== MODALS ========== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.3em;
            font-weight: 700;
            color: var(--navy);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.3em;
            cursor: pointer;
            color: #64748b;
            transition: color 0.3s ease;
        }

        .close-modal:hover {
            color: var(--navy);
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--navy);
            font-size: 0.9em;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.9em;
            transition: all 0.3s ease;
            background: var(--card-bg);
            color: var(--text-color);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--creator);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--creator) 0%, #7C3AED 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
        }

        .btn-secondary {
            background: var(--light);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: rgba(139, 92, 246, 0.1);
            border-color: var(--creator);
            color: var(--creator);
        }

        /* ========== NOTIFICATION ========== */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 10000;
            transform: translateX(150%);
            transition: transform 0.3s ease;
            max-width: 350px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: linear-gradient(135deg, var(--success), #20c997);
        }

        .notification.error {
            background: linear-gradient(135deg, var(--danger), #e83e8c);
        }

        .notification.info {
            background: linear-gradient(135deg, var(--info), #6f42c1);
        }

        /* ========== LOADING ========== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(5px);
        }

        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid var(--creator);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ========== EMPTY STATE ========== */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #64748b;
        }

        .empty-state-icon {
            font-size: 3em;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* ========== RESPONSIVE ========== */
        @media (max-width: 1200px) {
            .support-container {
                flex-direction: column;
            }
            
            .support-sidebar {
                width: 100%;
                height: auto;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
                flex-direction: row;
                flex-wrap: wrap;
                gap: 20px;
                padding: 20px;
            }
            
            .sidebar-section {
                border: none;
                padding: 0;
                flex: 1;
                min-width: 200px;
            }
        }

        @media (max-width: 768px) {
            .support-header {
                padding: 12px 16px;
                flex-wrap: wrap;
                gap: 12px;
            }
            
            .support-nav {
                width: 100%;
                justify-content: space-between;
            }
            
            .conversations-panel {
                width: 100%;
                border-right: none;
            }
            
            .message {
                max-width: 85%;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner"></div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <!-- Header -->
    <header class="support-header">
        <div class="support-brand">
            <div class="brand-logo">
                <i class="fas fa-headset"></i>
            </div>
            <div class="brand-text">EverNet Support</div>
            <div class="agent-status">
                <div class="status-dot"></div>
                <span id="agentStatusText">Available</span>
            </div>
        </div>
        
        <nav class="support-nav">
            <div class="user-menu">
                <div class="user-avatar" id="agentAvatar">A</div>
                <div>
                    <div style="font-weight: 600; font-size: 0.95em;" id="agentName"></div>
                    <div style="font-size: 0.85em; color: #64748b;" id="agentRole"></div>
                </div>
            </div>
            <button class="action-btn" onclick="toggleTheme()">
                <i class="fas fa-palette"></i>
            </button>
            <button class="action-btn" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i>
            </button>
        </nav>
    </header>

    <!-- Main Container -->
    <div class="support-container">
        <!-- Sidebar -->
        <aside class="support-sidebar">
            <div class="sidebar-section">
                <div class="section-title">Quick Stats</div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="openTicketsCount">0</div>
                        <div class="stat-label">Open</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="assignedTicketsCount">0</div>
                        <div class="stat-label">Assigned</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="responseTime">0m</div>
                        <div class="stat-label">Avg. Response</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="satisfactionRate">0%</div>
                        <div class="stat-label">Satisfaction</div>
                    </div>
                </div>
            </div>

            <div class="sidebar-section">
                <div class="section-title">Filters</div>
                <div class="filters-list">
                    <button class="filter-btn active" onclick="filterTickets('all')">
                        <span>All Conversations</span>
                        <span class="filter-count" id="filterAll">0</span>
                    </button>
                    <button class="filter-btn" onclick="filterTickets('unassigned')">
                        <span>Unassigned</span>
                        <span class="filter-count" id="filterUnassigned">0</span>
                    </button>
                    <button class="filter-btn" onclick="filterTickets('assigned')">
                        <span>Assigned to Me</span>
                        <span class="filter-count" id="filterAssigned">0</span>
                    </button>
                    <button class="filter-btn" onclick="filterTickets('unread')">
                        <span>Unread</span>
                        <span class="filter-count" id="filterUnread">0</span>
                    </button>
                    <button class="filter-btn" onclick="filterTickets('priority')">
                        <span>High Priority</span>
                        <span class="filter-count" id="filterPriority">0</span>
                    </button>
                </div>
            </div>

            <div class="sidebar-section">
                <div class="section-title">Team Online</div>
                <div class="team-list" id="teamList">
                    <!-- Team members will be loaded here -->
                </div>
            </div>

            <div class="sidebar-section">
                <div class="section-title">Quick Actions</div>
                <div class="filters-list">
                    <button class="filter-btn" onclick="openNewTicketModal()">
                        <i class="fas fa-plus"></i>
                        <span>New Conversation</span>
                    </button>
                    <button class="filter-btn" onclick="openCannedResponsesModal()">
                        <i class="fas fa-comment-dots"></i>
                        <span>Canned Responses</span>
                    </button>
                    <button class="filter-btn" onclick="openKnowledgeBase()">
                        <i class="fas fa-book"></i>
                        <span>Knowledge Base</span>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="support-main">
            <div style="display: flex; flex: 1; overflow: hidden;">
                <!-- Conversations List -->
                <div class="conversations-panel">
                    <div class="panel-header">
                        <div class="search-box">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" class="search-input" id="conversationSearch" 
                                   placeholder="Search conversations..." onkeyup="searchConversations()">
                        </div>
                    </div>
                    
                    <div class="conversations-list" id="conversationsList">
                        <!-- Conversations will be loaded here -->
                    </div>
                </div>

                <!-- Chat Panel -->
                <div class="chat-panel" id="chatPanel" style="display: none;">
                    <div class="chat-header">
                        <div class="chat-creator-info">
                            <div class="creator-avatar" id="currentCreatorAvatar">C</div>
                            <div class="creator-details">
                                <h3 id="currentCreatorName">Creator Name</h3>
                                <p id="currentCreatorEmail">creator@example.com</p>
                            </div>
                        </div>
                        
                        <div class="chat-actions">
                            <button class="action-btn" onclick="assignToMe()" id="assignBtn">
                                <i class="fas fa-user-plus"></i>
                            </button>
                            <button class="action-btn" onclick="setTicketPriority()">
                                <i class="fas fa-flag"></i>
                            </button>
                            <button class="action-btn" onclick="openTicketDetails()">
                                <i class="fas fa-info-circle"></i>
                            </button>
                            <button class="action-btn" onclick="resolveTicket()">
                                <i class="fas fa-check-circle"></i>
                            </button>
                        </div>
                    </div>

                    <div class="chat-messages" id="chatMessages">
                        <!-- Messages will be loaded here -->
                    </div>

                    <div class="chat-input-area">
                        <div class="chat-input-container">
                            <textarea class="chat-input" id="messageInput" 
                                      placeholder="Type your message here..." 
                                      onkeydown="handleMessageKeydown(event)"></textarea>
                            <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                        
                        <div class="input-actions">
                            <button class="attachment-btn" onclick="attachFile()">
                                <i class="fas fa-paperclip"></i>
                            </button>
                            <button class="attachment-btn" onclick="openCannedResponses()">
                                <i class="fas fa-comment-alt"></i>
                            </button>
                        </div>
                        
                        <div class="quick-responses" id="quickResponses" style="display: none;">
                            <div class="responses-header">
                                <div class="responses-title">Quick Responses</div>
                                <button class="response-btn" onclick="toggleQuickResponses()">Hide</button>
                            </div>
                            <div class="responses-list" id="responsesList">
                                <!-- Quick responses will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Empty State -->
                <div class="empty-state" id="emptyChatState">
                    <div class="empty-state-icon">
                        <i class="fas fa-comments"></i>
                    </div>
                    <h3 style="margin-bottom: 12px; color: var(--text-color);">No Conversation Selected</h3>
                    <p style="max-width: 300px; margin: 0 auto;">Select a conversation from the list or start a new one to begin chatting.</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <!-- New Ticket Modal -->
    <div class="modal" id="newTicketModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Start New Conversation</h3>
                <button class="close-modal" onclick="closeModal('newTicketModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="form-group">
                <label class="form-label">Select Creator</label>
                <select class="form-select" id="newTicketCreator">
                    <option value="">Select a creator...</option>
                    <!-- Creators will be populated here -->
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Subject</label>
                <input type="text" class="form-input" id="newTicketSubject" placeholder="Enter subject...">
            </div>
            
            <div class="form-group">
                <label class="form-label">Priority</label>
                <select class="form-select" id="newTicketPriority">
                    <option value="low">Low</option>
                    <option value="medium" selected>Medium</option>
                    <option value="high">High</option>
                    <option value="urgent">Urgent</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Category</label>
                <select class="form-select" id="newTicketCategory">
                    <option value="general">General Inquiry</option>
                    <option value="technical">Technical Support</option>
                    <option value="billing">Billing/Payment</option>
                    <option value="content">Content Issues</option>
                    <option value="account">Account Issues</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Initial Message</label>
                <textarea class="form-textarea" id="newTicketMessage" placeholder="Type your initial message..."></textarea>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('newTicketModal')">Cancel</button>
                <button class="btn btn-primary" onclick="createNewTicket()">Start Conversation</button>
            </div>
        </div>
    </div>

    <!-- Ticket Details Modal -->
    <div class="modal" id="ticketDetailsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Ticket Details</h3>
                <button class="close-modal" onclick="closeModal('ticketDetailsModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="ticketDetailsContent">
                <!-- Ticket details will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Canned Responses Modal -->
    <div class="modal" id="cannedResponsesModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Canned Responses</h3>
                <button class="close-modal" onclick="closeModal('cannedResponsesModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="form-group">
                <input type="text" class="form-input" id="responseSearch" placeholder="Search responses..." onkeyup="searchCannedResponses()">
            </div>
            
            <div id="cannedResponsesList" style="max-height: 400px; overflow-y: auto;">
                <!-- Canned responses will be loaded here -->
            </div>
        </div>
    </div>

    <!-- File Upload Modal -->
    <div class="modal" id="fileUploadModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Attach File</h3>
                <button class="close-modal" onclick="closeModal('fileUploadModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="form-group">
                <input type="file" class="form-input" id="fileInput" accept="image/*,.pdf,.doc,.docx,.txt">
                <small style="color: #64748b; margin-top: 4px; display: block;">
                    Supported formats: Images, PDF, DOC, DOCX, TXT (Max 10MB)
                </small>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('fileUploadModal')">Cancel</button>
                <button class="btn btn-primary" onclick="uploadFile()">Upload</button>
            </div>
        </div>
    </div>

    <!-- Firebase Configuration -->
    <script>
        // Use the same Firebase config as your admin portal
        const firebaseConfig = {
            apiKey: "AIzaSyAuSEqhLenwrEz-qrIn1drjAugy1YSkDlI",
            authDomain: "creators-portal-428c5.firebaseapp.com",
            projectId: "creators-portal-428c5",
            storageBucket: "creators-portal-428c5.firebasestorage.app",
            messagingSenderId: "499280036303",
            appId: "1:499280036303:web:b4d80d3b7fe1291381d2ba",
            measurementId: "G-CYWGD80FS5"
        };

        // Initialize Firebase
        let app, auth, db;
        try {
            app = firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            console.log('Firebase initialized successfully');
        } catch (error) {
            console.log('Firebase already initialized');
            app = firebase.app();
            auth = firebase.auth();
            db = firebase.firestore();
        }
    </script>

    <!-- Support Portal Script -->
    <script>
        // ========== GLOBAL VARIABLES ==========
        let currentAgent = null;
        let currentConversation = null;
        let conversations = [];
        let filteredConversations = [];
        let allCreators = [];
        let teamMembers = [];
        let cannedResponses = [];
        let messageListener = null;
        let conversationsListener = null;
        let teamListener = null;

        // ========== INITIALIZATION ==========
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Support Portal initializing...');
            initializeTheme();
            checkAuth();
        });

        async function checkAuth() {
            showLoading();
            
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    console.log('User authenticated:', user.email);
                    
                    try {
                        const userDoc = await db.collection('users').doc(user.uid).get();
                        
                        if (userDoc.exists) {
                            const userData = userDoc.data();
                            
                            // Check if user is support team member
                            const isSupportTeam = userData.role === 'admin' || 
                                                 userData.role === 'support' || 
                                                 (userData.permissions && userData.permissions.includes('support'));
                            
                            if (!isSupportTeam) {
                                showNotification('Access denied. Support team privileges required.', 'error');
                                setTimeout(() => {
                                    window.location.href = 'index.html';
                                }, 2000);
                                return;
                            }
                            
                            // Set agent data
                            currentAgent = {
                                id: user.uid,
                                email: user.email,
                                name: userData.name || user.email.split('@')[0],
                                role: userData.role || 'support',
                                status: 'available'
                            };
                            
                            updateAgentUI();
                            initializePortal();
                            
                        } else {
                            showAccessDenied();
                        }
                    } catch (error) {
                        console.error('Error checking user permissions:', error);
                        showAccessDenied();
                    }
                } else {
                    console.log('No user authenticated');
                    showAccessDenied();
                }
            });
        }

        function showAccessDenied() {
            document.body.innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; padding: 20px; text-align: center;">
                    <div style="background: rgba(220, 53, 69, 0.1); width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 20px;">
                        <i class="fas fa-ban" style="font-size: 2.5em; color: var(--danger);"></i>
                    </div>
                    <h2 style="margin-bottom: 12px; color: var(--text-color);">Access Denied</h2>
                    <p style="color: #64748b; margin-bottom: 24px; max-width: 400px;">
                        You must be a member of the support team to access this portal.
                    </p>
                    <button onclick="window.location.href='index.html'" 
                            style="padding: 12px 24px; background: linear-gradient(135deg, var(--creator) 0%, #7C3AED 100%); 
                                   color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                        Go to Login
                    </button>
                </div>
            `;
        }

        function updateAgentUI() {
            document.getElementById('agentName').textContent = currentAgent.name;
            document.getElementById('agentRole').textContent = currentAgent.role.charAt(0).toUpperCase() + currentAgent.role.slice(1);
            
            const initials = currentAgent.name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
            document.getElementById('agentAvatar').textContent = initials;
            document.getElementById('agentAvatar').style.background = `linear-gradient(135deg, ${getRandomColor()}, ${getRandomColor()})`;
        }

        function getRandomColor() {
            const colors = ['#8B5CF6', '#7C3AED', '#6D28D9', '#5B21B6', '#4C1D95'];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        async function initializePortal() {
            try {
                // Load initial data
                await Promise.all([
                    loadCreators(),
                    loadCannedResponses(),
                    loadTeamMembers(),
                    setupRealtimeListeners()
                ]);
                
                hideLoading();
                showNotification('Support portal loaded successfully!', 'success');
                
            } catch (error) {
                console.error('Error initializing portal:', error);
                showNotification('Error loading portal data', 'error');
                hideLoading();
            }
        }

        // ========== THEME MANAGEMENT ==========
        function initializeTheme() {
            const savedTheme = localStorage.getItem('supportTheme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
        }

        function toggleTheme() {
            const currentTheme = document.body.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            
            document.body.setAttribute('data-theme', newTheme);
            localStorage.setItem('supportTheme', newTheme);
            
            showNotification(`Theme changed to ${newTheme} mode`, 'info');
        }

        // ========== CONVERSATION MANAGEMENT ==========
        function setupRealtimeListeners() {
            // Listen for conversations
            conversationsListener = db.collection('supportTickets')
                .orderBy('lastUpdated', 'desc')
                .onSnapshot(async (snapshot) => {
                    conversations = [];
                    snapshot.forEach(doc => {
                        conversations.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    await updateConversationsList();
                    updateStats();
                }, error => {
                    console.error('Error listening to conversations:', error);
                });

            // Listen for team members
            teamListener = db.collection('users')
                .where('role', 'in', ['admin', 'support'])
                .onSnapshot((snapshot) => {
                    teamMembers = [];
                    snapshot.forEach(doc => {
                        const member = doc.data();
                        if (doc.id !== currentAgent.id) {
                            teamMembers.push({
                                id: doc.id,
                                ...member
                            });
                        }
                    });
                    
                    updateTeamList();
                });
        }

        async function updateConversationsList() {
            const conversationsList = document.getElementById('conversationsList');
            const searchTerm = document.getElementById('conversationSearch').value.toLowerCase();
            
            // Filter conversations
            filteredConversations = conversations.filter(conv => {
                const matchesSearch = !searchTerm || 
                    (conv.creatorName && conv.creatorName.toLowerCase().includes(searchTerm)) ||
                    (conv.creatorEmail && conv.creatorEmail.toLowerCase().includes(searchTerm)) ||
                    (conv.subject && conv.subject.toLowerCase().includes(searchTerm));
                
                return matchesSearch;
            });
            
            if (filteredConversations.length === 0) {
                conversationsList.innerHTML = `
                    <div class="empty-state" style="padding: 40px 20px;">
                        <div class="empty-state-icon"><i class="fas fa-comments"></i></div>
                        <p>No conversations found</p>
                    </div>
                `;
                return;
            }
            
            conversationsList.innerHTML = '';
            
            filteredConversations.forEach(conv => {
                const item = document.createElement('div');
                item.className = `conversation-item ${currentConversation?.id === conv.id ? 'active' : ''}`;
                item.onclick = () => selectConversation(conv.id);
                
                const unreadCount = conv.unreadCount && conv.unreadCount[currentAgent.id] || 0;
                const priorityClass = `priority-${conv.priority || 'medium'}`;
                const lastMessage = conv.lastMessage || 'No messages yet';
                const lastUpdated = conv.lastUpdated?.toDate ? conv.lastUpdated.toDate() : new Date(conv.lastUpdated);
                
                // Get creator initials
                const creatorInitials = conv.creatorName 
                    ? conv.creatorName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2)
                    : conv.creatorEmail.substring(0, 2).toUpperCase();
                
                item.innerHTML = `
                    <div class="creator-avatar" style="background: linear-gradient(135deg, ${getRandomColor()}, ${getRandomColor()})">
                        ${creatorInitials}
                    </div>
                    <div class="conversation-info">
                        <div class="conversation-header">
                            <div class="creator-name">${conv.creatorName || conv.creatorEmail}</div>
                            <div class="conversation-time">${formatTime(lastUpdated)}</div>
                        </div>
                        <div class="conversation-preview">${lastMessage}</div>
                        <div class="conversation-meta">
                            <span class="priority-badge ${priorityClass}">${conv.priority || 'medium'}</span>
                            ${conv.category ? `<span style="font-size: 0.75em; color: #64748b;"> ${conv.category}</span>` : ''}
                            ${unreadCount > 0 ? `<div class="unread-count">${unreadCount}</div>` : ''}
                        </div>
                    </div>
                `;
                
                conversationsList.appendChild(item);
            });
        }

        async function selectConversation(conversationId) {
            try {
                showLoading();
                
                // Stop previous message listener
                if (messageListener) {
                    messageListener();
                }
                
                // Get conversation data
                const convDoc = await db.collection('supportTickets').doc(conversationId).get();
                if (!convDoc.exists) {
                    showNotification('Conversation not found', 'error');
                    hideLoading();
                    return;
                }
                
                currentConversation = {
                    id: convDoc.id,
                    ...convDoc.data()
                };
                
                // Update UI
                document.getElementById('emptyChatState').style.display = 'none';
                document.getElementById('chatPanel').style.display = 'flex';
                
                // Update chat header
                document.getElementById('currentCreatorName').textContent = 
                    currentConversation.creatorName || currentConversation.creatorEmail;
                document.getElementById('currentCreatorEmail').textContent = 
                    currentConversation.creatorEmail;
                
                const creatorInitials = currentConversation.creatorName 
                    ? currentConversation.creatorName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2)
                    : currentConversation.creatorEmail.substring(0, 2).toUpperCase();
                
                document.getElementById('currentCreatorAvatar').textContent = creatorInitials;
                document.getElementById('currentCreatorAvatar').style.background = 
                    `linear-gradient(135deg, ${getRandomColor()}, ${getRandomColor()})`;
                
                // Update assign button
                const assignBtn = document.getElementById('assignBtn');
                if (currentConversation.assignedTo === currentAgent.id) {
                    assignBtn.innerHTML = '<i class="fas fa-user-check"></i>';
                    assignBtn.title = 'Assigned to you';
                } else if (currentConversation.assignedTo) {
                    assignBtn.innerHTML = '<i class="fas fa-user-friends"></i>';
                    assignBtn.title = 'Assigned to someone else';
                } else {
                    assignBtn.innerHTML = '<i class="fas fa-user-plus"></i>';
                    assignBtn.title = 'Assign to me';
                }
                
                // Load messages
                await loadMessages(conversationId);
                
                // Mark as read
                await markAsRead(conversationId);
                
                // Start listening for new messages
                setupMessageListener(conversationId);
                
                hideLoading();
                updateConversationsList();
                
            } catch (error) {
                console.error('Error selecting conversation:', error);
                showNotification('Error loading conversation', 'error');
                hideLoading();
            }
        }

        async function loadMessages(conversationId) {
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = '<div class="loading-text"><div class="loading-spinner"></div><p>Loading messages...</p></div>';
            
            try {
                const messagesSnapshot = await db.collection('supportTickets')
                    .doc(conversationId)
                    .collection('messages')
                    .orderBy('timestamp', 'asc')
                    .get();
                
                messagesContainer.innerHTML = '';
                
                if (messagesSnapshot.empty) {
                    messagesContainer.innerHTML = `
                        <div class="empty-state" style="padding: 40px 20px;">
                            <div class="empty-state-icon"><i class="fas fa-comment-slash"></i></div>
                            <p>No messages yet</p>
                            <p style="font-size: 0.9em; margin-top: 8px;">Start the conversation!</p>
                        </div>
                    `;
                    return;
                }
                
                let currentDate = null;
                
                messagesSnapshot.forEach(doc => {
                    const message = doc.data();
                    const messageDate = message.timestamp?.toDate ? message.timestamp.toDate() : new Date(message.timestamp);
                    const dateString = messageDate.toDateString();
                    
                    // Add date separator if needed
                    if (currentDate !== dateString) {
                        currentDate = dateString;
                        const dateDiv = document.createElement('div');
                        dateDiv.className = 'message-date';
                        dateDiv.innerHTML = `<span class="date-label">${formatDate(messageDate)}</span>`;
                        messagesContainer.appendChild(dateDiv);
                    }
                    
                    // Create message element
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${message.senderId === currentAgent.id ? 'outgoing' : 'incoming'}`;
                    
                    const senderInitials = message.senderName 
                        ? message.senderName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2)
                        : 'AI';
                    
                    messageDiv.innerHTML = `
                        <div class="message-avatar">${senderInitials}</div>
                        <div class="message-content">
                            <div class="message-actions">
                                <button class="action-btn" style="width: 24px; height: 24px; font-size: 0.8em;" onclick="copyMessage('${message.text}')">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                            <div class="message-text">${message.text}</div>
                            <div class="message-time">${formatTime(messageDate)}</div>
                        </div>
                    `;
                    
                    messagesContainer.appendChild(messageDiv);
                });
                
                // Scroll to bottom
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
            } catch (error) {
                console.error('Error loading messages:', error);
                messagesContainer.innerHTML = `
                    <div class="empty-state" style="padding: 40px 20px;">
                        <div class="empty-state-icon"><i class="fas fa-exclamation-triangle"></i></div>
                        <p>Error loading messages</p>
                    </div>
                `;
            }
        }

        function setupMessageListener(conversationId) {
            messageListener = db.collection('supportTickets')
                .doc(conversationId)
                .collection('messages')
                .orderBy('timestamp', 'desc')
                .limit(1)
                .onSnapshot((snapshot) => {
                    if (!snapshot.empty && currentConversation) {
                        loadMessages(conversationId);
                        
                        // Update last message and timestamp
                        const lastMessage = snapshot.docs[0].data();
                        db.collection('supportTickets').doc(conversationId).update({
                            lastMessage: lastMessage.text.substring(0, 100),
                            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                });
        }

        // ========== MESSAGE FUNCTIONS ==========
        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message || !currentConversation) {
                return;
            }
            
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            
            try {
                // Add message to Firestore
                await db.collection('supportTickets')
                    .doc(currentConversation.id)
                    .collection('messages')
                    .add({
                        text: message,
                        senderId: currentAgent.id,
                        senderName: currentAgent.name,
                        senderEmail: currentAgent.email,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        type: 'text',
                        readBy: [currentAgent.id]
                    });
                
                // Update conversation
                await db.collection('supportTickets').doc(currentConversation.id).update({
                    lastMessage: message.substring(0, 100),
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                    status: currentConversation.status === 'open' ? 'in-progress' : currentConversation.status,
                    [`unreadCount.${currentConversation.creatorId}`]: firebase.firestore.FieldValue.increment(1)
                });
                
                // Clear input
                messageInput.value = '';
                messageInput.style.height = 'auto';
                
                showNotification('Message sent!', 'success');
                
            } catch (error) {
                console.error('Error sending message:', error);
                showNotification('Error sending message', 'error');
            } finally {
                sendBtn.disabled = false;
            }
        }

        function handleMessageKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
            
            // Auto-resize textarea
            const textarea = event.target;
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';
        }

        async function markAsRead(conversationId) {
            if (!currentConversation || !currentAgent) return;
            
            try {
                // Update unread count for agent
                await db.collection('supportTickets').doc(conversationId).update({
                    [`unreadCount.${currentAgent.id}`]: 0
                });
                
            } catch (error) {
                console.error('Error marking as read:', error);
            }
        }

        function copyMessage(text) {
            navigator.clipboard.writeText(text).then(() => {
                showNotification('Message copied to clipboard!', 'success');
            }).catch(err => {
                console.error('Failed to copy: ', err);
            });
        }

        // ========== TICKET MANAGEMENT ==========
        async function assignToMe() {
            if (!currentConversation) return;
            
            try {
                await db.collection('supportTickets').doc(currentConversation.id).update({
                    assignedTo: currentAgent.id,
                    assignedToName: currentAgent.name,
                    assignedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'in-progress'
                });
                
                showNotification('Ticket assigned to you!', 'success');
                selectConversation(currentConversation.id);
                
            } catch (error) {
                console.error('Error assigning ticket:', error);
                showNotification('Error assigning ticket', 'error');
            }
        }

        async function resolveTicket() {
            if (!currentConversation) return;
            
            if (!confirm('Are you sure you want to resolve this ticket?')) {
                return;
            }
            
            try {
                await db.collection('supportTickets').doc(currentConversation.id).update({
                    status: 'resolved',
                    resolvedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    resolvedBy: currentAgent.id,
                    resolvedByName: currentAgent.name
                });
                
                // Send resolution message
                await db.collection('supportTickets')
                    .doc(currentConversation.id)
                    .collection('messages')
                    .add({
                        text: ` Ticket resolved by ${currentAgent.name}. If you need further assistance, please reopen this ticket.`,
                        senderId: currentAgent.id,
                        senderName: 'System',
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        type: 'system'
                    });
                
                showNotification('Ticket resolved successfully!', 'success');
                selectConversation(currentConversation.id);
                
            } catch (error) {
                console.error('Error resolving ticket:', error);
                showNotification('Error resolving ticket', 'error');
            }
        }

        async function createNewTicket() {
            const creatorId = document.getElementById('newTicketCreator').value;
            const subject = document.getElementById('newTicketSubject').value.trim();
            const priority = document.getElementById('newTicketPriority').value;
            const category = document.getElementById('newTicketCategory').value;
            const message = document.getElementById('newTicketMessage').value.trim();
            
            if (!creatorId || !subject || !message) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }
            
            const creator = allCreators.find(c => c.id === creatorId);
            if (!creator) {
                showNotification('Creator not found', 'error');
                return;
            }
            
            try {
                showLoading();
                
                // Create ticket
                const ticketRef = await db.collection('supportTickets').add({
                    creatorId: creator.id,
                    creatorEmail: creator.email,
                    creatorName: creator.name || creator.youtubeChannelName || creator.email.split('@')[0],
                    subject: subject,
                    priority: priority,
                    category: category,
                    status: 'open',
                    assignedTo: currentAgent.id,
                    assignedToName: currentAgent.name,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                    lastMessage: message.substring(0, 100),
                    unreadCount: {
                        [creator.id]: 1
                    }
                });
                
                // Add initial message
                await db.collection('supportTickets')
                    .doc(ticketRef.id)
                    .collection('messages')
                    .add({
                        text: message,
                        senderId: currentAgent.id,
                        senderName: currentAgent.name,
                        senderEmail: currentAgent.email,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        type: 'text',
                        readBy: [currentAgent.id]
                    });
                
                // Send notification to creator
                await db.collection('userNotifications').add({
                    userId: creator.id,
                    userEmail: creator.email,
                    title: 'New Support Ticket Created',
                    message: `A support ticket has been created for you: "${subject}"`,
                    type: 'info',
                    read: false,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    relatedTicket: ticketRef.id
                });
                
                closeModal('newTicketModal');
                showNotification('New ticket created successfully!', 'success');
                
                // Select the new ticket
                await selectConversation(ticketRef.id);
                
            } catch (error) {
                console.error('Error creating ticket:', error);
                showNotification('Error creating ticket: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // ========== DATA LOADING ==========
        async function loadCreators() {
            try {
                const creatorsSnapshot = await db.collection('users')
                    .where('role', '==', 'creator')
                    .get();
                
                allCreators = [];
                const select = document.getElementById('newTicketCreator');
                select.innerHTML = '<option value="">Select a creator...</option>';
                
                creatorsSnapshot.forEach(doc => {
                    const creator = {
                        id: doc.id,
                        ...doc.data()
                    };
                    allCreators.push(creator);
                    
                    const option = document.createElement('option');
                    option.value = creator.id;
                    option.textContent = creator.name || creator.youtubeChannelName || creator.email;
                    select.appendChild(option);
                });
                
            } catch (error) {
                console.error('Error loading creators:', error);
            }
        }

        async function loadCannedResponses() {
            try {
                // Try to load from admin settings first
                const settingsDoc = await db.collection('adminSettings').doc('cannedResponses').get();
                
                if (settingsDoc.exists) {
                    cannedResponses = settingsDoc.data().responses || [];
                } else {
                    // Default canned responses
                    cannedResponses = [
                        { id: 1, title: 'Greeting', text: 'Hello! How can I help you today?' },
                        { id: 2, title: 'Payment Issue', text: 'I understand you\'re having payment issues. Can you please provide more details?' },
                        { id: 3, title: 'Video Scanning', text: 'For video scanning issues, please ensure you\'re using the correct YouTube Shorts URL format.' },
                        { id: 4, title: 'Technical Support', text: 'Our technical team has been notified and will look into this issue shortly.' },
                        { id: 5, title: 'Resolution', text: 'Thank you for bringing this to our attention. The issue has been resolved.' },
                        { id: 6, title: 'Follow-up', text: 'Just following up on your previous inquiry. Is there anything else you need assistance with?' }
                    ];
                }
                
            } catch (error) {
                console.error('Error loading canned responses:', error);
                // Fallback to default responses
                cannedResponses = [
                    { id: 1, title: 'Greeting', text: 'Hello! How can I help you today?' }
                ];
            }
        }

        async function loadTeamMembers() {
            // Already handled by teamListener
        }

        function updateTeamList() {
            const teamList = document.getElementById('teamList');
            teamList.innerHTML = '';
            
            teamMembers.forEach(member => {
                const memberDiv = document.createElement('div');
                memberDiv.className = 'team-member';
                
                const initials = member.name 
                    ? member.name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2)
                    : member.email.substring(0, 2).toUpperCase();
                
                memberDiv.innerHTML = `
                    <div class="member-avatar" style="background: linear-gradient(135deg, ${getRandomColor()}, ${getRandomColor()})">
                        ${initials}
                    </div>
                    <div class="member-info">
                        <div class="member-name">${member.name || member.email}</div>
                        <div class="member-role">${member.role}</div>
                    </div>
                    <div class="member-status status-online"></div>
                `;
                
                teamList.appendChild(memberDiv);
            });
        }

        function updateStats() {
            const openTickets = conversations.filter(c => c.status === 'open').length;
            const assignedToMe = conversations.filter(c => c.assignedTo === currentAgent.id && c.status !== 'resolved').length;
            const unreadTickets = conversations.filter(c => c.unreadCount && c.unreadCount[currentAgent.id] > 0).length;
            const highPriority = conversations.filter(c => c.priority === 'high' || c.priority === 'urgent').length;
            
            // Update counts
            document.getElementById('openTicketsCount').textContent = openTickets;
            document.getElementById('assignedTicketsCount').textContent = assignedToMe;
            document.getElementById('filterAll').textContent = conversations.length;
            document.getElementById('filterUnassigned').textContent = conversations.filter(c => !c.assignedTo).length;
            document.getElementById('filterAssigned').textContent = assignedToMe;
            document.getElementById('filterUnread').textContent = unreadTickets;
            document.getElementById('filterPriority').textContent = highPriority;
            
            // Calculate average response time (simulated)
            const responseTime = conversations.length > 0 ? Math.floor(Math.random() * 60) + 5 : 0;
            const satisfactionRate = conversations.length > 0 ? Math.floor(Math.random() * 30) + 70 : 0;
            
            document.getElementById('responseTime').textContent = `${responseTime}m`;
            document.getElementById('satisfactionRate').textContent = `${satisfactionRate}%`;
        }

        // ========== FILTERS & SEARCH ==========
        function filterTickets(filterType) {
            // Remove active class from all filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            
            // Add active class to clicked button
            event.target.classList.add('active');
            
            // TODO: Implement filtering logic
            showNotification(`Filtering by: ${filterType}`, 'info');
        }

        function searchConversations() {
            updateConversationsList();
        }

        // ========== MODAL FUNCTIONS ==========
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function openNewTicketModal() {
            openModal('newTicketModal');
        }

        function openCannedResponsesModal() {
            openModal('cannedResponsesModal');
            loadCannedResponsesModal();
        }

        function openTicketDetails() {
            if (!currentConversation) {
                showNotification('No conversation selected', 'error');
                return;
            }
            
            openModal('ticketDetailsModal');
            loadTicketDetails();
        }

        function loadCannedResponsesModal() {
            const container = document.getElementById('cannedResponsesList');
            container.innerHTML = '';
            
            cannedResponses.forEach(response => {
                const responseDiv = document.createElement('div');
                responseDiv.className = 'team-member';
                responseDiv.style.cursor = 'pointer';
                responseDiv.onclick = () => useCannedResponse(response.text);
                
                responseDiv.innerHTML = `
                    <div style="flex: 1;">
                        <div style="font-weight: 500; margin-bottom: 4px;">${response.title}</div>
                        <div style="font-size: 0.85em; color: #64748b;">${response.text.substring(0, 80)}...</div>
                    </div>
                    <button class="action-btn" style="width: 32px; height: 32px;" onclick="event.stopPropagation(); copyCannedResponse('${response.text}')">
                        <i class="fas fa-copy"></i>
                    </button>
                `;
                
                container.appendChild(responseDiv);
            });
        }

        function loadTicketDetails() {
            if (!currentConversation) return;
            
            const container = document.getElementById('ticketDetailsContent');
            
            const createdAt = currentConversation.createdAt?.toDate ? 
                currentConversation.createdAt.toDate() : new Date(currentConversation.createdAt);
            const lastUpdated = currentConversation.lastUpdated?.toDate ? 
                currentConversation.lastUpdated.toDate() : new Date(currentConversation.lastUpdated);
            
            container.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <div>
                            <strong>Status:</strong>
                            <span class="priority-badge priority-${currentConversation.priority}" style="margin-left: 8px;">
                                ${currentConversation.status || 'open'}
                            </span>
                        </div>
                        <div>
                            <strong>Priority:</strong>
                            <span class="priority-badge priority-${currentConversation.priority}" style="margin-left: 8px;">
                                ${currentConversation.priority || 'medium'}
                            </span>
                        </div>
                    </div>
                    
                    <div style="background: var(--light); padding: 16px; border-radius: 8px; margin: 12px 0;">
                        <div style="font-weight: 600; margin-bottom: 8px;">${currentConversation.subject}</div>
                        <div style="font-size: 0.9em; color: #64748b;">${currentConversation.category || 'General'}</div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                        <div>
                            <div style="font-size: 0.85em; color: #64748b; margin-bottom: 4px;">Created</div>
                            <div style="font-weight: 500;">${formatDateTime(createdAt)}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.85em; color: #64748b; margin-bottom: 4px;">Last Updated</div>
                            <div style="font-weight: 500;">${formatDateTime(lastUpdated)}</div>
                        </div>
                    </div>
                    
                    <div>
                        <div style="font-size: 0.85em; color: #64748b; margin-bottom: 4px;">Assigned To</div>
                        <div style="font-weight: 500;">${currentConversation.assignedToName || 'Unassigned'}</div>
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button class="btn btn-secondary" onclick="closeModal('ticketDetailsModal')">Close</button>
                    <button class="btn btn-primary" onclick="editTicketDetails()">Edit Details</button>
                </div>
            `;
        }

        function editTicketDetails() {
            // TODO: Implement ticket editing
            showNotification('Ticket editing feature coming soon!', 'info');
        }

        function useCannedResponse(text) {
            document.getElementById('messageInput').value = text;
            closeModal('cannedResponsesModal');
            document.getElementById('messageInput').focus();
        }

        function copyCannedResponse(text) {
            navigator.clipboard.writeText(text).then(() => {
                showNotification('Response copied to clipboard!', 'success');
            });
        }

        function openCannedResponses() {
            const quickResponses = document.getElementById('quickResponses');
            if (quickResponses.style.display === 'none') {
                quickResponses.style.display = 'block';
                loadQuickResponses();
            } else {
                quickResponses.style.display = 'none';
            }
        }

        function toggleQuickResponses() {
            const quickResponses = document.getElementById('quickResponses');
            quickResponses.style.display = quickResponses.style.display === 'none' ? 'block' : 'none';
        }

        function loadQuickResponses() {
            const container = document.getElementById('responsesList');
            container.innerHTML = '';
            
            cannedResponses.slice(0, 5).forEach(response => {
                const button = document.createElement('button');
                button.className = 'response-btn';
                button.textContent = response.title;
                button.onclick = () => useCannedResponse(response.text);
                container.appendChild(button);
            });
        }

        function searchCannedResponses() {
            const searchTerm = document.getElementById('responseSearch').value.toLowerCase();
            const container = document.getElementById('cannedResponsesList');
            
            container.innerHTML = '';
            
            const filtered = cannedResponses.filter(r => 
                r.title.toLowerCase().includes(searchTerm) || 
                r.text.toLowerCase().includes(searchTerm)
            );
            
            filtered.forEach(response => {
                const responseDiv = document.createElement('div');
                responseDiv.className = 'team-member';
                responseDiv.style.cursor = 'pointer';
                responseDiv.onclick = () => useCannedResponse(response.text);
                
                responseDiv.innerHTML = `
                    <div style="flex: 1;">
                        <div style="font-weight: 500; margin-bottom: 4px;">${response.title}</div>
                        <div style="font-size: 0.85em; color: #64748b;">${response.text.substring(0, 80)}...</div>
                    </div>
                    <button class="action-btn" style="width: 32px; height: 32px;" onclick="event.stopPropagation(); copyCannedResponse('${response.text}')">
                        <i class="fas fa-copy"></i>
                    </button>
                `;
                
                container.appendChild(responseDiv);
            });
        }

        function setTicketPriority() {
            if (!currentConversation) return;
            
            const newPriority = prompt('Set priority (low, medium, high, urgent):', currentConversation.priority);
            if (!newPriority || !['low', 'medium', 'high', 'urgent'].includes(newPriority.toLowerCase())) {
                return;
            }
            
            db.collection('supportTickets').doc(currentConversation.id).update({
                priority: newPriority.toLowerCase()
            }).then(() => {
                showNotification(`Priority set to ${newPriority}`, 'success');
            }).catch(error => {
                console.error('Error setting priority:', error);
                showNotification('Error setting priority', 'error');
            });
        }

        function attachFile() {
            openModal('fileUploadModal');
        }

        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showNotification('Please select a file', 'error');
                return;
            }
            
            // Validate file size (10MB)
            if (file.size > 10 * 1024 * 1024) {
                showNotification('File size must be less than 10MB', 'error');
                return;
            }
            
            // Validate file type
            const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'application/pdf', 
                                  'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                                  'text/plain'];
            
            if (!allowedTypes.includes(file.type)) {
                showNotification('File type not supported', 'error');
                return;
            }
            
            try {
                showLoading();
                
                // In a real implementation, you would upload to Firebase Storage
                // For now, we'll simulate it
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Add message with file info
                await db.collection('supportTickets')
                    .doc(currentConversation.id)
                    .collection('messages')
                    .add({
                        text: ` Attached file: ${file.name} (${(file.size / 1024).toFixed(1)}KB)`,
                        senderId: currentAgent.id,
                        senderName: currentAgent.name,
                        senderEmail: currentAgent.email,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        type: 'file',
                        fileName: file.name,
                        fileSize: file.size,
                        fileType: file.type
                    });
                
                closeModal('fileUploadModal');
                showNotification('File attached successfully!', 'success');
                
            } catch (error) {
                console.error('Error uploading file:', error);
                showNotification('Error uploading file', 'error');
            } finally {
                hideLoading();
                fileInput.value = '';
            }
        }

        function openKnowledgeBase() {
            showNotification('Knowledge Base feature coming soon!', 'info');
        }

        // ========== UTILITY FUNCTIONS ==========
        function formatTime(date) {
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) { // Less than 1 minute
                return 'Just now';
            } else if (diff < 3600000) { // Less than 1 hour
                const minutes = Math.floor(diff / 60000);
                return `${minutes}m ago`;
            } else if (diff < 86400000) { // Less than 1 day
                const hours = Math.floor(diff / 3600000);
                return `${hours}h ago`;
            } else if (diff < 604800000) { // Less than 1 week
                const days = Math.floor(diff / 86400000);
                return `${days}d ago`;
            } else {
                return date.toLocaleDateString();
            }
        }

        function formatDate(date) {
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            if (date.toDateString() === today.toDateString()) {
                return 'Today';
            } else if (date.toDateString() === yesterday.toDateString()) {
                return 'Yesterday';
            } else if (date.getFullYear() === today.getFullYear()) {
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            } else {
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            }
        }

        function formatDateTime(date) {
            return `${formatDate(date)} at ${date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }

        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // ========== LOGOUT ==========
        async function logout() {
            try {
                await auth.signOut();
                showNotification('Successfully signed out', 'success');
                
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1000);
                
            } catch (error) {
                console.error('Logout error:', error);
                showNotification('Error signing out', 'error');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
            }
        }

        // ========== CLEANUP ==========
        window.addEventListener('beforeunload', function() {
            if (messageListener) {
                messageListener();
            }
            if (conversationsListener) {
                conversationsListener();
            }
            if (teamListener) {
                teamListener();
            }
        });
    </script>
</body>
</html>